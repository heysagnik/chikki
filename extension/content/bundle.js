class d{constructor(){this.selectedText="",this.currentSelection=null,this.currentRange=null,this.generatedText="",this.isLoading=!1,this.init(),console.log("Chikki extension loaded")}init(){this.createUIElements(),this.setupEventListeners(),this.injectStyles()}injectStyles(){if(document.getElementById("chikki-styles"))return;const t=document.createElement("style");t.id="chikki-styles",fetch(chrome.runtime.getURL("content/content-style.css")).then(e=>e.text()).then(e=>{t.textContent=e,document.head.appendChild(t)}).catch(e=>console.error("Failed to load Chikki styles:",e))}createUIElements(){this.container=document.getElementById("chikki-container"),this.container||(this.container=document.createElement("div"),this.container.id="chikki-container",this.container.style.cssText="position: absolute; top: 0; left: 0; width: 0; height: 0; z-index: 2147483647;",document.body.appendChild(this.container)),this.editIcon=document.createElement("div"),this.editIcon.id="chikki-edit-icon",this.editIcon.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="16px" height="16px"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',this.editIcon.style.display="none",this.editIcon.setAttribute("role","button"),this.editIcon.setAttribute("aria-label","Edit selected text"),this.container.appendChild(this.editIcon),this.promptContainer=document.createElement("div"),this.promptContainer.id="chikki-prompt-container",this.promptContainer.style.display="none",this.promptInput=document.createElement("input"),this.promptInput.id="chikki-prompt-input",this.promptInput.type="text",this.promptInput.placeholder="Enter prompt and press Enter...",this.promptInput.setAttribute("aria-label","Prompt input"),this.promptContainer.appendChild(this.promptInput),this.container.appendChild(this.promptContainer),this.resultContainer=document.createElement("div"),this.resultContainer.id="chikki-result-container",this.resultContainer.style.display="none",this.generatedContent=document.createElement("div"),this.generatedContent.id="chikki-generated-content",this.resultContainer.appendChild(this.generatedContent),this.replaceButton=document.createElement("button"),this.replaceButton.id="chikki-replace-button",this.replaceButton.textContent="Replace",this.replaceButton.setAttribute("aria-label","Replace selection with generated text"),this.resultContainer.appendChild(this.replaceButton),this.container.appendChild(this.resultContainer),this.loadingIndicator=document.createElement("div"),this.loadingIndicator.id="chikki-loading",this.loadingIndicator.textContent="Generating...",this.loadingIndicator.style.cssText=`
        display: none; /* Initially hidden */
        padding: 8px 10px;
        font-style: italic;
        color: #555;
    `,this.promptContainer.appendChild(this.loadingIndicator)}setupEventListeners(){document.addEventListener("mouseup",this.handleTextSelection.bind(this),!0);let t;document.addEventListener("selectionchange",()=>{clearTimeout(t),t=setTimeout(()=>this.handleSelectionChange(),150)}),this.editIcon.addEventListener("click",this.handleEditIconClick.bind(this)),this.promptInput.addEventListener("keydown",this.handlePromptInputKeydown.bind(this)),this.replaceButton.addEventListener("click",this.handleReplaceButtonClick.bind(this)),document.addEventListener("mousedown",this.handleClickOutside.bind(this),!0)}handleSelectionChange(){this.editIcon.style.display==="none"&&this.handleTextSelection()}handleTextSelection(t){t&&(this.container.contains(t.target)||this.editIcon.contains(t.target)||this.promptContainer.contains(t.target)||this.resultContainer.contains(t.target))||setTimeout(()=>{const e=window.getSelection(),n=e.toString().trim();if(n&&e.rangeCount>0){if(n!==this.selectedText||this.editIcon.style.display==="none"){console.log("Text selected:",n),this.selectedText=n;const i=e.getRangeAt(0),s=i.getBoundingClientRect();if(s.width>0||s.height>0){this.currentSelection=e,this.currentRange=i.cloneRange();const l=32,a=window.scrollX,r=window.scrollY;this.editIcon.style.top=`${r+s.bottom+5}px`,this.editIcon.style.left=`${a+s.right-l/2}px`,this.editIcon.style.display="flex",this.promptContainer.style.display="none",this.resultContainer.style.display="none",console.log("Edit icon positioned at:",this.editIcon.style.top,this.editIcon.style.left)}else this.hideAllUIElements()}}else this.promptContainer.style.display==="none"&&this.resultContainer.style.display==="none"&&(this.selectedText="",this.editIcon.style.display="none")},50)}handleEditIconClick(t){if(t.stopPropagation(),t.preventDefault(),console.log("Edit icon clicked"),!this.currentRange)return;this.editIcon.style.display="none";const e=this.currentRange.getBoundingClientRect(),n=window.scrollX,i=window.scrollY;this.promptContainer.style.top=`${i+e.bottom+10}px`,this.promptContainer.style.left=`${n+e.left}px`,this.promptContainer.style.display="block",this.promptInput.value="",this.promptInput.disabled=!1,this.loadingIndicator.style.display="none",this.promptInput.style.display="block",this.promptInput.focus()}async handlePromptInputKeydown(t){if(t.key==="Enter"&&!this.isLoading){t.preventDefault();const e=this.promptInput.value.trim();if(!e)return;console.log("Processing prompt:",e),this.isLoading=!0,this.promptInput.disabled=!0,this.promptInput.style.display="none",this.loadingIndicator.style.display="block";try{const n=await new Promise((a,r)=>{chrome.runtime.sendMessage({type:"generate",prompt:`Selected text: "${this.selectedText}"
Prompt: "${e}"`},o=>{if(chrome.runtime.lastError)return r(new Error(chrome.runtime.lastError.message));o&&o.error?r(new Error(o.error)):o&&o.data?a(o.data):r(new Error("Invalid response from background script"))})});console.log("Received generated text:",n),this.generatedText=n,this.generatedContent.textContent=this.generatedText;const i=this.currentRange.getBoundingClientRect(),s=window.scrollX,l=window.scrollY;this.resultContainer.style.top=`${l+i.bottom+10}px`,this.resultContainer.style.left=`${s+i.left}px`,this.resultContainer.style.display="flex",this.promptContainer.style.display="none"}catch(n){console.error("Error generating text:",n),this.generatedContent.textContent=`Error: ${n.message||"Unknown error"}`;const i=this.currentRange.getBoundingClientRect(),s=window.scrollX,l=window.scrollY;this.resultContainer.style.top=`${l+i.bottom+10}px`,this.resultContainer.style.left=`${s+i.left}px`,this.resultContainer.style.display="flex",this.replaceButton.style.display="none",this.promptContainer.style.display="none"}finally{this.isLoading=!1,this.promptInput.disabled=!1,this.promptInput.value="",this.loadingIndicator.style.display="none",this.promptInput.style.display="block"}}else t.key==="Escape"&&(t.preventDefault(),this.hideAllUIElements())}handleReplaceButtonClick(t){if(t.stopPropagation(),t.preventDefault(),console.log("Replace button clicked"),this.currentSelection&&this.currentRange&&this.generatedText)try{this.currentSelection.removeAllRanges(),this.currentSelection.addRange(this.currentRange),this.currentRange.deleteContents();const e=document.createTextNode(this.generatedText);this.currentRange.insertNode(e),this.currentRange.setStartAfter(e),this.currentRange.collapse(!0),this.currentSelection.removeAllRanges(),this.currentSelection.addRange(this.currentRange),console.log("Text replaced successfully")}catch(e){console.error("Error replacing text:",e),alert("Error replacing text: "+e.message)}finally{this.hideAllUIElements(),this.resetState()}else console.warn("Replace clicked but state was invalid:",{hasSelection:!!this.currentSelection,hasRange:!!this.currentRange,hasGeneratedText:!!this.generatedText}),this.hideAllUIElements(),this.resetState()}handleClickOutside(t){!this.container.contains(t.target)&&this.editIcon.style.display==="none"&&this.promptContainer.style.display==="none"&&this.resultContainer.style.display==="none"||this.container&&!this.container.contains(t.target)&&this.hideAllUIElements()}hideAllUIElements(){this.editIcon.style.display="none",this.promptContainer.style.display="none",this.resultContainer.style.display="none",this.promptInput.value="",this.promptInput.disabled=!1,this.loadingIndicator.style.display="none",this.promptInput.style.display="block"}resetState(){this.selectedText="",this.generatedText="",this.currentSelection=null,this.currentRange=null,this.isLoading=!1,window.getSelection&&window.getSelection().removeAllRanges()}}function c(){window.chikkiInstance?console.log("Chikki instance already exists."):(console.log("Initializing Chikki instance."),window.chikkiInstance=new d)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",c):c();
