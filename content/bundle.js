class k{constructor(){}parseMarkdown(e){try{return e=this.processHeaders(e),e=this.processFormatting(e),e=this.processLists(e),e=this.processCodeElements(e),e=this.processBlockElements(e),e=this.processParagraphs(e),e}catch(t){return console.error("Error parsing markdown:",t),e||""}}processHeaders(e){return e?(e=e.replace(/^# (.*?)$/gm,"<h1>$1</h1>"),e=e.replace(/^## (.*?)$/gm,"<h2>$1</h2>"),e=e.replace(/^### (.*?)$/gm,"<h3>$1</h3>"),e=e.replace(/^#### (.*?)$/gm,"<h4>$1</h4>"),e=e.replace(/^##### (.*?)$/gm,"<h5>$1</h5>"),e=e.replace(/^###### (.*?)$/gm,"<h6>$1</h6>"),e):""}processFormatting(e){return e?(e=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/__(.*?)__/g,"<strong>$1</strong>"),e=e.replace(/\*(.*?)\*/g,"<em>$1</em>"),e=e.replace(/_(.*?)_/g,"<em>$1</em>"),e=e.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>'),e):""}processLists(e){return e?(e=e.replace(/^\* (.*?)$/gm,"<ul><li>$1</li></ul>"),e=e.replace(/^\- (.*?)$/gm,"<ul><li>$1</li></ul>"),e=e.replace(/<\/ul>\s*<ul>/g,""),e=e.replace(/^\d+\. (.*?)$/gm,"<ol><li>$1</li></ol>"),e=e.replace(/<\/ol>\s*<ol>/g,""),e):""}processCodeElements(e){return e?(e=e.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>"),e=e.replace(/`([^`]+)`/g,"<code>$1</code>"),e):""}processBlockElements(e){return e?(e=e.replace(/^> (.*?)$/gm,"<blockquote>$1</blockquote>"),e=e.replace(/^---$/gm,"<hr>"),e):""}processParagraphs(e){return e?(e=e.replace(/\r\n/g,`
`),e=e.split(/\n\n+/).map(i=>i.trim().startsWith("<")&&i.trim().endsWith(">")?i:`<p>${i.replace(/\n/g,"<br>")}</p>`).join(""),e):""}sanitizeHTML(e){return e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}}class C{constructor(){}async fetchGeneratedText(e,t){try{const i=o=>new Promise(r=>setTimeout(r,o)),[n]=await Promise.all([new Promise((o,r)=>{if(!chrome||!chrome.runtime||!chrome.runtime.sendMessage){r(new Error("Chrome runtime API is not available"));return}chrome.runtime.sendMessage({type:"generate",prompt:`Context: "${e||""}"
Request: "${t}"`},s=>{if(chrome.runtime.lastError)return r(new Error(chrome.runtime.lastError.message||"Chrome runtime error occurred"));if(!s)return r(new Error("Empty response from background script"));if(s.error)return r(new Error(s.error));s.data!==void 0?o(s.data):r(new Error("Invalid response format from background script"))})}),i(900)]);return n}catch(i){throw console.error("Error fetching generated text:",i),i}}async fetchRegeneratedText(e,t,i){try{const n=`Regenerate this: ${t}
Previous result: ${i||""}`;return await this.fetchGeneratedText(e,n)}catch(n){throw console.error("Error fetching regenerated text:",n),n}}}class f{constructor(){}adjustPositionForViewport(e,t,i,n){const o=window.scrollX||0,r=window.scrollY||0,s=window.innerWidth||document.documentElement.clientWidth,a=window.innerHeight||document.documentElement.clientHeight,c=16,h=Math.min(i,s-c*2);let d=Math.max(o+c,t);d=Math.min(d,o+s-h-c);let u=Math.max(r+c,e);return u=Math.min(u,r+a-n-c),{top:u,left:d,width:h}}calculateEditIconPosition(e){const i=window.scrollX||0,n=window.scrollY||0;let o=n+e.bottom+8,r=i+e.left+e.width/2-40/2;o+40+8>n+(window.innerHeight||document.documentElement.clientHeight)&&(o=n+e.top-40-8);const s=this.adjustPositionForViewport(o,r,40,40);return{top:s.top,left:s.left,width:40,height:40}}}class y{constructor(e){this.core=e,this.container=null,this.editIcon=null,this.universalContainer=null,this.promptInput=null,this.loadingIndicator=null,this.skeletonContainer=null,this.generatedContent=null,this.regenerateButton=null,this.replaceButton=null,this.generateButton=null}createUIElements(){this.setupContainer(),this.setupEditIcon(),this.setupUniversalContainer()}setupContainer(){this.container=document.getElementById("chikki-container"),this.container||(this.container=document.createElement("div"),this.container.id="chikki-container",this.container.style.cssText="position: absolute; top: 0; left: 0; width: 0; height: 0; z-index: 2147483647; display: none;",document.body.appendChild(this.container))}setupEditIcon(){this.editIcon=document.createElement("div"),this.editIcon.id="chikki-edit-icon",this.editIcon.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="16px" height="16px"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>',this.editIcon.style.display="none",this.editIcon.setAttribute("role","button"),this.editIcon.setAttribute("aria-label","Edit selected text"),this.container.appendChild(this.editIcon)}setupUniversalContainer(){this.universalContainer=document.createElement("div"),this.universalContainer.id="chikki-universal-container",this.universalContainer.className="chikki-universal-container",this.universalContainer.style.display="none";const e=document.createElement("div");e.className="chikki-prompt-section",this.promptInput=document.createElement("textarea"),this.promptInput.id="chikki-prompt-input",this.promptInput.placeholder="Message Copilot",this.promptInput.setAttribute("aria-label","Prompt input"),this.promptInput.setAttribute("rows","3"),e.appendChild(this.promptInput);const t=document.createElement("div");t.className="chikki-bottom-bar";const i=document.createElement("div");i.className="chikki-prompt-left";const n=document.createElement("div");n.className="chikki-logo",n.innerHTML=`<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 4.29L6 7.57v8.86l6 3.43 6-3.43V7.57l-6-3.28z" fill="#FF5252" />
      <path d="M6 7.57l6 3.43v8.86l-6-3.43V7.57z" fill="#FF7B7B" />
      <path d="M18 7.57l-6 3.43v8.86l6-3.43V7.57z" fill="#E53935" />
      <path d="M6 7.57l6-3.28 6 3.28-6 3.43-6-3.43z" fill="#FF9E80" />
    </svg>`,i.appendChild(n);const o=document.createElement("div");o.className="chikki-prompt-right",this.generateButton=document.createElement("button"),this.generateButton.id="chikki-generate-button",this.generateButton.className="chikki-generate-button",this.generateButton.textContent="Generate",this.generateButton.setAttribute("aria-label","Generate response"),o.appendChild(this.generateButton),t.appendChild(i),t.appendChild(o),e.appendChild(t),this.loadingIndicator=document.createElement("div"),this.loadingIndicator.id="chikki-loading",this.loadingIndicator.textContent="Generating magic...",this.loadingIndicator.style.display="none",this.skeletonContainer=document.createElement("div"),this.skeletonContainer.id="chikki-skeleton-container",this.skeletonContainer.style.display="none";const r=document.createElement("div");r.className="chikki-skeleton-header",r.style.cssText="width: 60%; height: 18px; margin-bottom: 24px !important;",r.classList.add("chikki-skeleton-line"),this.skeletonContainer.appendChild(r);const s=["80%","95%","75%","85%","70%"];for(let p=0;p<5;p++){const m=document.createElement("div");m.className="chikki-skeleton-line",m.style.width=s[p],p>0&&(m.style.marginLeft="20px",m.style.position="relative"),this.skeletonContainer.appendChild(m)}const a=document.createElement("div");a.className="chikki-result-section",a.style.display="none",this.generatedContent=document.createElement("div"),this.generatedContent.id="chikki-generated-content",a.appendChild(this.generatedContent);const c=document.createElement("div");c.className="chikki-button-container",this.regenerateButton=document.createElement("button"),this.regenerateButton.id="chikki-regenerate-button",this.regenerateButton.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path></svg><span>Regenerate</span>',this.replaceButton=document.createElement("button"),this.replaceButton.id="chikki-replace-button",this.replaceButton.textContent="Replace",c.appendChild(this.regenerateButton),c.appendChild(this.replaceButton),a.appendChild(c);const h=document.createElement("div");h.className="chikki-result-actions";const d=document.createElement("button");d.className="chikki-action-button",d.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M16 1H4C2.9 1 2 1.9 2 3v14h2V3h12V1zm3 4H8C6.9 5 6 5.9 6 7v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> Copy';const u=document.createElement("button");u.className="chikki-action-button primary",u.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg> Edit in Word',h.appendChild(d),h.appendChild(u),a.appendChild(h),d.addEventListener("click",()=>{this.generatedContent&&navigator.clipboard.writeText(this.generatedContent.innerText).then(()=>{d.classList.add("success"),setTimeout(()=>d.classList.remove("success"),1500)})}),this.generateButton.addEventListener("click",()=>{const p=this.promptInput.value.trim();!p||this.core.interaction.isLoading||(this.animateToLoadingState(),setTimeout(()=>{this.core.interaction.processPrompt(p)},150))}),this.universalContainer.appendChild(e),this.universalContainer.appendChild(this.loadingIndicator),this.universalContainer.appendChild(this.skeletonContainer),this.universalContainer.appendChild(a),this.container.appendChild(this.universalContainer)}updateReplaceButtonText(e){this.replaceButton&&(this.replaceButton.textContent=e?"Replace":"Insert",this.replaceButton.setAttribute("aria-label",e?"Replace selection with generated text":"Insert generated text at cursor position"))}hideEditIcon(){this.editIcon&&(this.editIcon.style.display="none")}hideAllUIElements(){this.universalContainer&&this.universalContainer.classList.remove("active","loading","result-mode"),setTimeout(()=>{if(this.editIcon&&(this.editIcon.style.display="none",this.editIcon.classList.remove("expanding")),this.universalContainer){this.universalContainer.style.display="none",this.promptInput&&(this.promptInput.value="",this.promptInput.disabled=!1,this.promptInput.style.opacity="1",this.promptInput.style.transform="none"),this.loadingIndicator&&(this.loadingIndicator.style.display="none",this.loadingIndicator.style.opacity="0"),this.skeletonContainer&&(this.skeletonContainer.style.display="none",this.skeletonContainer.style.opacity="0",this.skeletonContainer.querySelectorAll(".chikki-skeleton-line").forEach(n=>{n.classList.remove("chikki-loading-pulse")}));const e=this.universalContainer.querySelector(".chikki-prompt-section"),t=this.universalContainer.querySelector(".chikki-result-section");e&&(e.style.display="flex",e.style.opacity="1"),t&&(t.style.display="none"),this.generateButton&&(this.generateButton.disabled=!1,this.generateButton.classList.remove("loading"))}this.container&&(this.container.style.display="none")},150)}isClickInsideComponent(e){try{return!e||!e.target?!1:this.container&&this.container.contains(e.target)||this.editIcon&&this.editIcon.contains(e.target)||this.universalContainer&&this.universalContainer.contains(e.target)}catch(t){return console.error("Error checking if click is inside component:",t),!1}}animateToLoadingState(){this.promptInput&&(this.promptInput.disabled=!0,this.promptInput.style.opacity="0",this.promptInput.style.transform="translateY(10px)"),this.generateButton&&(this.generateButton.disabled=!0,this.generateButton.classList.add("loading")),this.universalContainer.classList.add("loading");const e=this.universalContainer.querySelector(".chikki-prompt-section");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none",this.loadingIndicator&&(this.loadingIndicator.style.display="block",this.loadingIndicator.style.opacity="1",this.loadingIndicator.style.padding="24px 24px 0 24px"),this.skeletonContainer&&(this.skeletonContainer.style.display="block",this.skeletonContainer.style.opacity="1",this.skeletonContainer.style.padding="24px",this.skeletonContainer.querySelectorAll(".chikki-skeleton-line").forEach((i,n)=>{setTimeout(()=>{i.classList.add("chikki-loading-pulse")},n*50)}))},100)),this.universalContainer.style.height="var(--chikki-result-min-height)",this.universalContainer.style.width="var(--chikki-result-width)"}showResultState(e){e&&(this.loadingIndicator&&(this.loadingIndicator.style.opacity="0"),this.skeletonContainer&&(this.skeletonContainer.style.opacity="0"),setTimeout(()=>{if(this.loadingIndicator&&(this.loadingIndicator.style.display="none"),this.skeletonContainer&&(this.skeletonContainer.style.display="none"),this.generatedContent){this.generatedContent.innerHTML=e;const t=this.universalContainer.querySelector(".chikki-result-section");if(t){const n=t.querySelector(".chikki-result-actions");n&&n.remove(),t.style.display="flex",this.universalContainer.classList.remove("loading"),this.universalContainer.classList.add("result-mode","active")}const i=this.universalContainer.querySelector(".chikki-prompt-section");i&&(i.style.display="none")}},200))}}class w{constructor(e){this.core=e,this.selectedText="",this.currentSelection=null,this.currentRange=null,this.hasTextSelection=!1,this.editIconPosition=null}handleTextSelection(e){e&&this.core.ui.isClickInsideComponent(e)||setTimeout(()=>{var s,a,c,h;const t=window.getSelection();if(!t||t.rangeCount===0){this.core.ui.hideEditIcon(),this.hasTextSelection=!1,this.core.ui.updateReplaceButtonText(this.hasTextSelection);return}const i=t.getRangeAt(0),n=t.toString().trim();if(i.collapsed||!n||n.length===0){this.hasTextSelection=!1,!((s=this.core.ui.promptContainer)!=null&&s.classList.contains("active"))&&!((a=this.core.ui.resultContainer)!=null&&a.classList.contains("active"))&&this.core.ui.hideEditIcon(),this.core.ui.updateReplaceButtonText(this.hasTextSelection);return}let o=i.commonAncestorContainer;if(o.nodeType===Node.TEXT_NODE&&(o=o.parentNode),!(o&&(o.tagName==="INPUT"||o.tagName==="TEXTAREA"||o.isContentEditable))){this.hasTextSelection=!1,!((c=this.core.ui.promptContainer)!=null&&c.classList.contains("active"))&&!((h=this.core.ui.resultContainer)!=null&&h.classList.contains("active"))&&this.core.ui.hideEditIcon(),this.core.ui.updateReplaceButtonText(this.hasTextSelection);return}this.hasTextSelection=!0,this.shouldUpdateSelection(n)&&this.updateSelectionData(n,t),this.core.ui.updateReplaceButtonText(this.hasTextSelection)},50)}shouldUpdateSelection(e){return e&&(e!==this.selectedText||this.core.ui.editIcon&&this.core.ui.editIcon.style.display==="none"&&this.core.ui.promptContainer&&!this.core.ui.promptContainer.classList.contains("active")&&this.core.ui.resultContainer&&!this.core.ui.resultContainer.classList.contains("active"))}updateSelectionData(e,t){this.selectedText=e;const i=t.getRangeAt(0),n=i.getBoundingClientRect();n.width>0||n.height>0?(this.hasTextSelection=e.length>0,this.currentSelection=t,this.currentRange=i.cloneRange(),this.core.ui.container&&(this.core.ui.container.style.display="block"),this.positionEditIcon(n),this.core.ui.updateReplaceButtonText(this.hasTextSelection)):this.core.ui.hideAllUIElements()}positionEditIcon(e){const i=window.scrollX||0,n=window.scrollY||0;let o=n+e.bottom+8,r=i+e.left+e.width/2-40/2;o+40+8>n+(window.innerHeight||document.documentElement.clientHeight)&&(o=n+e.top-40-8);const s=this.core.positionManager.adjustPositionForViewport(o,r,40,40);this.editIconPosition={top:s.top,left:s.left,width:40,height:40},this.core.ui.editIcon&&(this.core.ui.editIcon.style.top=`${s.top}px`,this.core.ui.editIcon.style.left=`${s.left}px`,this.core.ui.editIcon.style.display="flex",this.core.ui.editIcon.classList.remove("expanding")),this.core.ui.promptContainer&&(this.core.ui.promptContainer.classList.remove("active","transitioning-out"),this.core.ui.promptContainer.style.display="none"),this.core.ui.resultContainer&&(this.core.ui.resultContainer.classList.remove("active"),this.core.ui.resultContainer.style.display="none")}isPlainTextContext(e){try{const t=e.startContainer,i=t.nodeType===Node.TEXT_NODE?t.parentNode:t;return i.tagName==="INPUT"||i.tagName==="TEXTAREA"||i.getAttribute("contenteditable")==="false"}catch{return!0}}}class v{constructor(e){this.core=e,this.isLoading=!1,this.generatedText=""}setupEventListeners(){document.addEventListener("mouseup",this.handleTextSelection.bind(this),!0),this.core.ui.editIcon&&this.core.ui.editIcon.addEventListener("click",this.handleEditIconClick.bind(this)),this.core.ui.promptInput&&this.core.ui.promptInput.addEventListener("keydown",this.handlePromptInputKeydown.bind(this)),this.core.ui.replaceButton&&this.core.ui.replaceButton.addEventListener("click",this.handleReplaceButtonClick.bind(this)),this.core.ui.regenerateButton&&this.core.ui.regenerateButton.addEventListener("click",this.handleRegenerateButtonClick.bind(this)),document.addEventListener("mousedown",this.handleClickOutside.bind(this),!0)}handleTextSelection(e){this.core.selection.handleTextSelection(e)}handleEditIconClick(e){if(e&&(e.stopPropagation(),e.preventDefault()),!this.core.selection.currentRange||!this.core.selection.editIconPosition)return;const t=400,i=120;if(!this.core.ui.editIcon)return;const n=this.core.ui.editIcon.getBoundingClientRect(),o=n.top,r=n.left+n.width/2-t/2,s=this.core.positionManager.adjustPositionForViewport(o,r,t,i);this.core.ui.universalContainer&&(this.core.ui.universalContainer.style.top=`${s.top}px`,this.core.ui.universalContainer.style.left=`${s.left}px`,this.core.ui.universalContainer.style.width=`${t}px`,this.core.ui.universalContainer.style.height=`${i}px`,this.core.ui.universalContainer.style.display="flex"),this.core.ui.editIcon&&this.core.ui.editIcon.classList.add("expanding"),setTimeout(()=>{this.core.ui.universalContainer&&this.core.ui.universalContainer.classList.add("active"),setTimeout(()=>{this.core.ui.promptInput&&this.core.ui.promptInput.focus(),this.core.ui.editIcon&&(this.core.ui.editIcon.style.display="none",this.core.ui.editIcon.classList.remove("expanding"))},150)},20)}async processPrompt(e){if(!(this.isLoading||!e)){this.isLoading=!0;try{const t=await this.core.api.fetchGeneratedText(this.core.selection.selectedText,e);this.generatedText=t,this.core.animation.positionResultContainer(this.core.selection.editIconPosition)}catch(t){this.core.animation.handleApiError(t,this.core.selection.editIconPosition)}finally{this.core.animation.resetLoadingState(),this.isLoading=!1}}}async handlePromptInputKeydown(e){if(e.key==="Enter"&&!this.isLoading){if(e.preventDefault(),!this.core.ui.promptInput)return;const t=this.core.ui.promptInput.value.trim();await this.processPrompt(t)}else e.key==="Escape"&&(e.preventDefault(),this.core.ui.hideAllUIElements())}async handleRegenerateButtonClick(e){var t;if(e&&(e.stopPropagation(),e.preventDefault()),!this.isLoading){this.isLoading=!0,this.core.ui.resultContainer&&this.core.ui.resultContainer.classList.add("regenerating"),this.core.animation.showLoadingState(this.core.selection.editIconPosition),this.core.ui.loadingIndicator&&this.core.ui.loadingIndicator.classList.add("regenerate-animation");try{const i=((t=this.core.ui.promptInput)==null?void 0:t.value.trim())||"",n=await this.core.api.fetchGeneratedText(this.core.selection.selectedText,i);this.generatedText=n,this.core.animation.positionResultContainer(this.core.selection.editIconPosition),this.core.content.renderGeneratedContent(this.generatedText),this.core.animation.animateTransitionToResult()}catch(i){this.core.animation.handleApiError(i,this.core.selection.editIconPosition)}finally{this.core.ui.resultContainer&&this.core.ui.resultContainer.classList.remove("regenerating"),this.core.ui.loadingIndicator&&this.core.ui.loadingIndicator.classList.remove("regenerate-animation"),this.core.animation.resetLoadingState(),this.isLoading=!1}}}handleReplaceButtonClick(e){if(e&&(e.stopPropagation(),e.preventDefault()),!this.core.selection.currentRange||!this.generatedText)return;this.core.selection.currentRange.deleteContents();const t=document.createTextNode(this.generatedText);this.core.selection.currentRange.insertNode(t),this.core.selection.currentRange.commonAncestorContainer.nodeType===Node.ELEMENT_NODE&&this.core.selection.currentRange.commonAncestorContainer.normalize(),this.core.ui.hideAllUIElements(),this.generatedText="",this.isLoading=!1}handleClickOutside(e){if(!e||!e.target)return;this.core.ui.isClickInsideComponent(e)||this.core.ui.hideAllUIElements()}handleGenerateButtonClick(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.isLoading)return;const t=this.core.ui.promptInput.value.trim();t&&(this.core.ui.animateToLoadingState(),setTimeout(()=>{this.processPrompt(t)},300))}}class I{constructor(e){this.core=e}showLoadingState(e){this.core.ui.promptInput&&(this.core.ui.promptInput.style.opacity="0",this.core.ui.promptInput.style.transform="translateY(10px)"),this.core.ui.promptContainer&&this.core.ui.promptContainer.classList.add("loading");const t=400,i=180;if(!e)if(this.core.ui.promptContainer&&this.core.ui.promptContainer.style.display!=="none"){const s=this.core.ui.promptContainer.getBoundingClientRect();e={top:s.top+window.scrollY,left:s.left+window.scrollX,width:s.width,height:s.height}}else return;let n=e.top,o=e.left+e.width/2-t/2;const r=this.core.positionManager.adjustPositionForViewport(n,o,t,i);this.core.ui.promptContainer&&(this.core.ui.promptContainer.style.top=`${r.top}px`,this.core.ui.promptContainer.style.left=`${r.left}px`,this.core.ui.promptContainer.style.width=`${r.width}px`,this.core.ui.promptContainer.style.height=`${i}px`),this.core.ui.skeletonContainer&&(this.core.ui.skeletonContainer.style.display="block",this.core.ui.skeletonContainer.querySelectorAll(".chikki-skeleton-line").forEach(a=>a.classList.add("chikki-loading-pulse")))}resetLoadingState(){this.core.interaction.isLoading=!1,this.core.ui.promptInput&&(this.core.ui.promptInput.disabled=!1,this.core.ui.promptInput.style.opacity="1",this.core.ui.promptInput.style.transform="none"),this.core.ui.skeletonContainer&&(this.core.ui.skeletonContainer.style.display="none")}positionResultContainer(e){if(!e)return;let i=e.top,n=e.left+e.width/2-400/2;const o=this.core.positionManager.adjustPositionForViewport(i,n,400,180);this.core.ui.universalContainer&&(this.core.ui.universalContainer.style.width=`${o.width}px`,this.core.ui.showResultState(this.core.interaction.generatedText))}animateTransitionToResult(){setTimeout(()=>{this.core.ui.resultContainer&&this.core.ui.resultContainer.classList.add("active"),setTimeout(()=>{this.core.ui.promptContainer&&(this.core.ui.promptContainer.classList.remove("active","transitioning-out","loading"),this.core.ui.promptContainer.style.display="none")},300)},50)}handleApiError(e,t){if(this.resetLoadingState(),this.positionResultContainer(t),this.core.ui.resultContainer){this.core.ui.resultContainer.innerHTML="",this.core.ui.resultContainer.classList.add("error");const i=document.createElement("div");i.className="chikki-error-icon",i.innerHTML="⚠️";const n=document.createElement("div");n.className="chikki-error-title",n.textContent="Error Occurred";const o=document.createElement("div");o.className="chikki-error-message",o.textContent=e.message||"Failed to process your request. Please try again.";const r=document.createElement("button");r.className="chikki-retry-button",r.textContent="Try Again",r.onclick=()=>{this.core.ui.hideAllUIElements(),setTimeout(()=>this.core.ui.showPrompt(),100)};const s=document.createElement("div");s.className="chikki-error-container",s.appendChild(i),s.appendChild(n),s.appendChild(o),s.appendChild(r),this.core.ui.resultContainer.appendChild(s),this.animateTransitionToResult()}}animateRegenerationResult(){if(this.core.ui.resultContainer){this.core.ui.resultContainer.classList.remove("regenerating"),this.core.ui.resultContainer.querySelectorAll(".chikki-skeleton-line").forEach(i=>{i.classList.remove("chikki-loading-pulse")});const t=this.core.ui.resultContainer.querySelector(".chikki-result-content");t&&(t.style.opacity="0",t.style.display="block",setTimeout(()=>{t.style.opacity="1"},50))}}setupRegenerationLoading(e){if(this.core.ui.resultContainer){this.core.ui.resultContainer.classList.add("regenerating");const t=this.core.ui.resultContainer.querySelector(".chikki-result-content");t&&(t.style.opacity="0");let i=this.core.ui.resultContainer.querySelector(".chikki-regeneration-skeleton");if(!i){i=document.createElement("div"),i.className="chikki-regeneration-skeleton",this.core.ui.resultContainer.appendChild(i);for(let o=0;o<5;o++){const r=document.createElement("div");r.className="chikki-skeleton-line",r.style.width=`${Math.floor(50+Math.random()*40)}%`,i.appendChild(r)}}i.querySelectorAll(".chikki-skeleton-line").forEach(o=>{o.classList.add("chikki-loading-pulse")}),this.core.ui.resultContainer.style.display="flex"}}}class E{constructor(e){this.core=e}renderGeneratedContent(e){try{if(!e)return;if(/[#*_\[\]`]/.test(e))this.renderMarkdown(e);else{const i=this.sanitizeHTML(e);this.core.ui.generatedContent&&(this.core.ui.generatedContent.innerHTML=i)}this.core.ui.updateReplaceButtonText(this.core.selection.hasTextSelection),this.core.ui.resultContainer&&(this.core.ui.resultContainer.style.display="block")}catch(t){console.error("Error rendering generated content:",t)}}renderMarkdown(e){try{let t=this.sanitizeHTML(e);const i=this.core.markdown.parseMarkdown(t);this.core.ui.generatedContent&&(this.core.ui.generatedContent.className="chikki-markdown",this.core.ui.generatedContent.innerHTML=i)}catch(t){console.error("Error rendering markdown:",t)}}sanitizeHTML(e){return e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}}class L{constructor(){this.init()}init(){try{this.markdown=new k,this.api=new C,this.positionManager=new f,this.ui=new y(this),this.selection=new w(this),this.content=new E(this),this.interaction=new v(this),this.animation=new I(this),this.ui.createUIElements(),this.interaction.setupEventListeners(),console.log("Chikki extension loaded")}catch(e){console.error("Error initializing Chikki:",e)}}resetState(){try{if(this.selection.selectedText="",this.interaction.generatedText="",this.selection.currentSelection=null,this.selection.currentRange=null,this.interaction.isLoading=!1,window.getSelection){const e=window.getSelection();e&&e.removeAllRanges()}}catch(e){console.error("Error resetting state:",e)}}}function g(){try{window.chikkiInstance||(window.chikkiInstance=new L,console.log("Chikki initialized successfully"))}catch(l){console.error("Error initializing Chikki:",l)}}try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g):g()}catch(l){console.error("Error setting up Chikki initialization:",l)}
