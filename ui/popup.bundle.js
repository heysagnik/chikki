let t={isLoggedIn:!1,user:null,token:null};const w=document.getElementById("auth-section"),v=document.getElementById("dashboard-section"),S=document.querySelectorAll(".tab-btn"),R=document.getElementById("login-form"),q=document.getElementById("register-form"),y=document.getElementById("login-email"),f=document.getElementById("login-password"),a=document.getElementById("login-btn"),L=document.getElementById("register-name"),I=document.getElementById("register-email"),m=document.getElementById("register-password"),l=document.getElementById("register-btn"),D=document.getElementById("logout-btn"),c=document.getElementById("health-status-dot"),u=document.getElementById("health-status-text"),d=document.getElementById("user-name"),g=document.getElementById("user-email"),k=document.getElementById("user-plan"),i=document.getElementById("status-message");function r(e,n="info"){i&&(i.textContent=e,i.className=`status ${n}`,(n==="success"||n==="info")&&setTimeout(()=>{i.textContent===e&&(i.textContent="",i.className="status")},5e3))}function b(){w&&w.classList.remove("hidden"),v&&v.classList.add("hidden"),y&&(y.value=""),f&&(f.value=""),L&&(L.value=""),I&&(I.value=""),m&&(m.value=""),B("login")}function C(){w&&w.classList.add("hidden"),v&&v.classList.remove("hidden"),P()}function P(){if(!t.isLoggedIn||!t.user){d&&(d.textContent="..."),g&&(g.textContent="..."),k&&(k.textContent="...");return}d&&(d.textContent=t.user.name||"N/A"),g&&(g.textContent=t.user.email||"N/A"),k&&(k.textContent=t.user.email_verified?"Verified":"Free")}function p(e){if(!(!u||!c))switch(e){case"online":u.textContent="Online",c.className="status-dot online";break;case"warning":u.textContent="Degraded",c.className="status-dot warning";break;case"offline":default:u.textContent="Offline",c.className="status-dot offline";break}}function B(e){S.forEach(o=>{o.classList.toggle("active",o.getAttribute("data-tab")===e)});const n=e==="login";R&&R.classList.toggle("active",n),q&&q.classList.toggle("active",!n),r("")}async function H(){try{console.log("[checkAuthState] Reading from storage...");const e=await chrome.storage.local.get(["authToken","user"]);console.log("[checkAuthState] Data read from storage:",JSON.stringify(e)),e&&e.authToken&&typeof e.authToken=="string"&&e.user&&typeof e.user=="object"?(console.log("[checkAuthState] Token and user found. Setting state."),t.token=e.authToken,t.user=e.user,t.isLoggedIn=!0,C(),console.log("[checkAuthState] Requesting health and profile updates from Service Worker..."),A(),M()):(console.log("[checkAuthState] Condition failed. Calling handleLogout(false)."),x(!1))}catch(e){console.error("[checkAuthState] Error:",e),r("Error loading extension state.","error"),b()}}async function T(){if(!y||!f)return;const e=y.value.trim(),n=f.value.trim();if(!e||!n)return r("Please enter both email and password","warning");r("Logging in...","loading"),a&&(a.disabled=!0);try{const o=await new Promise((s,E)=>{chrome.runtime.sendMessage({action:"login",data:{email:e,password:n}},h=>{if(chrome.runtime.lastError)return E(new Error(chrome.runtime.lastError.message||"Communication error"));if(!h)return E(new Error("No response from service worker"));s(h)})});if(console.log("Response from service worker for login:",o),!o.success||!o.token||!o.user)throw new Error(o.error||"Login failed. Invalid response.");t.token=o.token,t.user=o.user,t.isLoggedIn=!0,r("Login successful!","success"),C(),A()}catch(o){console.error("Login error:",o),r(`Login failed: ${o.message}`,"error"),b()}finally{a&&(a.disabled=!1)}}async function F(){if(!L||!I||!m)return;const e=L.value.trim(),n=I.value.trim(),o=m.value.trim();if(!e||!n||!o)return r("Please fill in all fields","warning");if(!/\S+@\S+\.\S+/.test(n))return r("Please enter a valid email address","warning");if(o.length<6)return r("Password must be at least 6 characters","warning");r("Creating account...","loading"),l&&(l.disabled=!0);try{const s=await new Promise((E,h)=>{chrome.runtime.sendMessage({action:"register",data:{name:e,email:n,password:o}},N=>{if(chrome.runtime.lastError)return h(new Error(chrome.runtime.lastError.message||"Communication error"));if(!N)return h(new Error("No response from service worker"));E(N)})});if(console.log("Response from service worker for register:",s),!s.success||!s.token||!s.user)throw new Error(s.error||"Registration failed. Invalid response.");t.token=s.token,t.user=s.user,t.isLoggedIn=!0,r("Account created successfully!","success"),C(),A()}catch(s){console.error("Register error:",s),r(`Registration failed: ${s.message}`,"error"),B("register")}finally{l&&(l.disabled=!1)}}function x(e=!0){console.log("[handleLogout] Logging out...");const n=t.isLoggedIn;t={token:null,user:null,isLoggedIn:!1},chrome.storage.local.remove(["authToken","user"],()=>{chrome.runtime.lastError&&console.error("Error clearing auth token from storage:",chrome.runtime.lastError),console.log("[handleLogout] Storage cleared."),b(),e&&n&&r("You have been logged out","info")}),P(),p("offline")}async function A(){if(console.log("[Popup] Sending getHealth request to Service Worker..."),!(!u||!c)){u.textContent="Checking...",c.className="status-dot";try{const e=await chrome.runtime.sendMessage({action:"getHealth"});console.log("[Popup] Response from getHealth:",e),e&&e.success?p(e.health):(console.error("Failed to get health status:",e==null?void 0:e.error),p("offline"))}catch(e){console.error("Error sending getHealth message:",e),p("offline")}}}async function M(){console.log("[Popup] Sending getProfile request to Service Worker...");try{const e=await chrome.runtime.sendMessage({action:"getProfile"});console.log("[Popup] Response from getProfile:",e),e?e.success&&e.user?(t.user=e.user,t.isLoggedIn=!0,P(),console.log("[Popup] User profile updated.")):(console.error("Failed to get user profile:",e.error),e.requiresLogout?(console.log("[Popup] Profile fetch indicated logout required."),r("Session expired. Please log in again.","warning"),x(!1)):(d&&(d.textContent="Error"),g&&(g.textContent="Could not load"),r("Failed to refresh profile data","error"))):(console.error("No response received for getProfile request."),r("Failed to refresh profile data","error"))}catch(e){console.error("Error sending getProfile message:",e),r("Failed to refresh profile data","error")}}document.addEventListener("DOMContentLoaded",()=>{H(),S&&S.forEach(e=>{e.addEventListener("click",()=>{B(e.getAttribute("data-tab"))})}),a&&a.addEventListener("click",T),l&&l.addEventListener("click",F),D&&D.addEventListener("click",()=>x(!0)),f&&f.addEventListener("keypress",e=>{e.key==="Enter"&&(e.preventDefault(),T())}),m&&m.addEventListener("keypress",e=>{e.key==="Enter"&&(e.preventDefault(),F())})});
